<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡é›²ç«¯å³æ™‚æ¸¬é©—ç³»çµ± - è€å¸«ç®¡ç†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Lexend', 'Noto Sans TC', sans-serif; background-color: #F8FAFC; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 
            10%, 90% { transform: translate3d(-1px, 0, 0); } 
            20%, 80% { transform: translate3d(2px, 0, 0); } 
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 
            40%, 60% { transform: translate3d(4px, 0, 0); } 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ğŸ”‘ ä½ çš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUlvu46XOZe5tKULG17nJLHaTA9-Cbp1c",
            authDomain: "eng-practice-d3a17.firebaseapp.com",
            databaseURL: "https://eng-practice-d3a17-default-rtdb.firebaseio.com", 
            projectId: "eng-practice-d3a17",
            storageBucket: "eng-practice-d3a17.firebasestorage.app",
            messagingSenderId: "1015937569709",
            appId: "1:1015937569709:web:b82f057d2068e1be4a4724",
            measurementId: "G-WNCJQDVXYY"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- é¡Œåº«å€åŸŸ ---
        const quizData = [
            { id: 1, question: "She _______ to the library every Sunday morning.", options: ["go", "goes", "going", "gone"], correct: "goes", explanation: "ä¸»è©ç‚ºç¬¬ä¸‰äººç¨±å–®æ•¸ (She)ï¼Œç¾åœ¨å¼å‹•è©éœ€åŠ  s/esã€‚" },
            { id: 2, question: "I am looking forward to _______ you soon.", options: ["see", "saw", "seeing", "seen"], correct: "seeing", explanation: "look forward to é€™è£¡çš„ to æ˜¯ä»‹ç³»è©ï¼Œå¾Œæ–¹å¿…é ˆæ¥å‹•åè© V-ingã€‚" },
            { id: 3, question: "The movie was so _______ that I fell asleep.", options: ["excited", "exciting", "bored", "boring"], correct: "boring", explanation: "å½¢å®¹äº‹ç‰©ï¼ˆé›»å½±ï¼‰è®“äººæ„Ÿåˆ°ç„¡èŠï¼Œæ‡‰ä½¿ç”¨ V-ing å½¢å¼çš„å½¢å®¹è©ã€‚" }
        ];

        function App() {
            const [view, setView] = useState('login'); 
            const [studentName, setStudentName] = useState('');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [status, setStatus] = useState('idle');
            const [selectedOption, setSelectedOption] = useState(null);
            const [allLogs, setAllLogs] = useState([]);
            const [expandedKey, setExpandedKey] = useState(null); // æ§åˆ¶å¾Œå°å“ªå¼µå¡ç‰‡å±•é–‹
            const startTimeRef = useRef(null);

            useEffect(() => {
                const logsRef = db.ref('quiz_logs');
                logsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const logsArray = Object.entries(data).map(([key, val]) => ({ ...val, firebaseId: key }));
                        setAllLogs(logsArray);
                    }
                });
                return () => logsRef.off();
            }, []);

            const handleAnswer = (choice) => {
                const endTime = Date.now();
                const timeTaken = ((endTime - startTimeRef.current) / 1000).toFixed(2);
                const isCorrect = choice === quizData[currentIdx].correct;
                
                // å¢åŠ ä¸€å€‹ sessionIDï¼Œç”¨å§“å+æ—¥æœŸ+å°æ™‚åˆ†é˜ä¾†ç¾¤çµ„åŒ–
                const now = new Date();
                const sessionID = `${studentName}_${now.toLocaleDateString()}_${now.getHours()}:${now.getMinutes()}`;

                const logData = {
                    name: studentName,
                    sessionID: sessionID,
                    qId: quizData[currentIdx].id,
                    qText: quizData[currentIdx].question,
                    choice,
                    isCorrect,
                    timeTaken,
                    timestamp: now.toLocaleString()
                };

                db.ref('quiz_logs').push(logData);
                setSelectedOption(choice);
                setStatus(isCorrect ? 'correct' : 'wrong');
            };

            // ç®¡ç†å“¡å¾Œå°è³‡æ–™åˆ†çµ„é‚è¼¯
            const groupedSessions = useMemo(() => {
                const groups = {};
                allLogs.forEach(log => {
                    const key = log.sessionID || `${log.name}_unknown`;
                    if (!groups[key]) {
                        groups[key] = {
                            name: log.name,
                            timestamp: log.timestamp,
                            items: [],
                            correctCount: 0
                        };
                    }
                    groups[key].items.push(log);
                    if (log.isCorrect) groups[key].correctCount++;
                });
                return Object.entries(groups).reverse(); // æœ€æ–°æ™‚é–“æ’å‰é¢
            }, [allLogs]);

            // --- 1. å­¸ç”Ÿç™»å…¥ç•«é¢ ---
            if (view === 'login') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-indigo-600 p-6">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
                            <h1 className="text-3xl font-black text-indigo-900 mb-2">EngQuiz</h1>
                            <p className="text-slate-400 text-sm mb-8 font-bold">é›²ç«¯åŒæ­¥æ¸¬é©—ç³»çµ±</p>
                            <input type="text" placeholder="è«‹è¼¸å…¥å§“å" 
                                className="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl mb-4 text-center font-bold outline-none"
                                value={studentName} onChange={e => setStudentName(e.target.value)} />
                            <button onClick={() => studentName && setView('quiz')} 
                                className="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-all">
                                é–‹å§‹æ¸¬é©—
                            </button>
                            <button onClick={() => setView('admin_login')} className="mt-8 text-indigo-200 text-xs font-bold hover:text-white transition-colors">ç®¡ç†å“¡ç™»å…¥</button>
                        </div>
                    </div>
                );
            }

            // --- 2. å­¸ç”Ÿæ¸¬é©—ä»‹é¢ ---
            if (view === 'quiz') {
                if (status === 'idle') startTimeRef.current = Date.now();
                return (
                    <div className="max-w-md mx-auto mt-12 p-8 bg-white rounded-[2.5rem] shadow-xl border border-slate-100 relative">
                        <div className="flex justify-between items-center mb-6">
                            <span className="text-[10px] font-black text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full uppercase tracking-widest">Live Cloud</span>
                            <span className="text-xs font-bold text-slate-300">Q {currentIdx + 1} / {quizData.length}</span>
                        </div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-8 leading-tight">{quizData[currentIdx].question}</h2>
                        <div className="space-y-3">
                            {quizData[currentIdx].options.map((opt, i) => {
                                let btnClass = "border-slate-50 hover:border-indigo-500 hover:bg-indigo-50";
                                if (status !== 'idle') {
                                    if (opt === quizData[currentIdx].correct) btnClass = "border-green-500 bg-green-50 text-green-700 shadow-sm";
                                    else if (opt === selectedOption && status === 'wrong') btnClass = "border-red-500 bg-red-50 text-red-700 animate-shake";
                                    else btnClass = "border-slate-50 opacity-30";
                                }
                                return (
                                    <button key={i} onClick={() => status === 'idle' && handleAnswer(opt)}
                                        className={`w-full p-5 text-left border-2 rounded-2xl font-bold transition-all ${btnClass}`}>
                                        {opt}
                                    </button>
                                );
                            })}
                        </div>
                        {status !== 'idle' && (
                            <div className={`mt-8 p-6 rounded-3xl border-2 transition-all ${status === 'correct' ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                                <h3 className={`font-black mb-2 ${status === 'correct' ? 'text-green-600' : 'text-red-600'}`}>
                                    {status === 'correct' ? 'âœ… ç­”å°äº†ï¼' : `âŒ ç­”éŒ¯äº† (æ­£è§£: ${quizData[currentIdx].correct})`}
                                </h3>
                                <p className="text-sm text-slate-600 mb-4 bg-white/50 p-3 rounded-xl border border-white">
                                    <strong>è§£æï¼š</strong>{quizData[currentIdx].explanation}
                                </p>
                                <button onClick={() => {
                                    if(currentIdx < quizData.length - 1) { setCurrentIdx(currentIdx+1); setStatus('idle'); setSelectedOption(null); }
                                    else { alert("æ¸¬é©—å®Œæˆï¼"); setView('login'); setCurrentIdx(0); setStatus('idle'); }
                                }} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">
                                    {currentIdx < quizData.length - 1 ? "ä¸‹ä¸€é¡Œ" : "çµæŸæ¸¬é©—"}
                                </button>
                            </div>
                        )}
                    </div>
                );
            }

            // --- 3. è€å¸«ç®¡ç†å¾Œå° (å„ªåŒ–æ”¶åˆä»‹é¢) ---
            if (view === 'admin') {
                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <div className="flex justify-between items-end mb-8">
                            <div>
                                <h1 className="text-4xl font-black text-slate-800 tracking-tighter uppercase">Records</h1>
                                <p className="text-slate-400 font-bold">é»æ“Šå¡ç‰‡æŸ¥çœ‹è©³ç´°ä½œç­”ç´€éŒ„</p>
                            </div>
                            <button onClick={() => setView('login')} className="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold shadow-lg">é€€å‡ºå¾Œå°</button>
                        </div>

                        <div className="space-y-4">
                            {groupedSessions.length === 0 ? (
                                <div className="p-20 text-center text-slate-300 font-bold bg-white rounded-[2rem] border border-dashed border-slate-200">ç›®å‰å°šç„¡é›²ç«¯ç´€éŒ„</div>
                            ) : groupedSessions.map(([key, session]) => {
                                const isOpen = expandedKey === key;
                                const totalTime = session.items.reduce((acc, curr) => acc + parseFloat(curr.timeTaken), 0).toFixed(1);
                                
                                return (
                                    <div key={key} className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden transition-all duration-300">
                                        {/* å¡ç‰‡æ¨™é¡Œ - é»æ“Šå±•é–‹ */}
                                        <div 
                                            className="p-6 cursor-pointer flex items-center justify-between hover:bg-slate-50 transition-colors"
                                            onClick={() => setExpandedKey(isOpen ? null : key)}
                                        >
                                            <div className="flex items-center space-x-4">
                                                <div className="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-black text-xl">
                                                    {session.name.charAt(0)}
                                                </div>
                                                <div>
                                                    <h3 className="font-black text-slate-700">{session.name}</h3>
                                                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{session.timestamp}</p>
                                                </div>
                                            </div>

                                            <div className="flex items-center space-x-8">
                                                <div className="text-right">
                                                    <p className="text-[10px] text-slate-400 font-black uppercase">æ­£ç¢ºç‡</p>
                                                    <p className={`text-lg font-black ${session.correctCount === session.items.length ? 'text-green-500' : 'text-orange-500'}`}>
                                                        {session.correctCount} / {session.items.length}
                                                    </p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-[10px] text-slate-400 font-black uppercase">ç¸½æ™‚é•·</p>
                                                    <p className="text-lg font-black text-slate-700">{totalTime}s</p>
                                                </div>
                                                <div className={`text-slate-300 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}>
                                                    â–¼
                                                </div>
                                            </div>
                                        </div>

                                        {/* è©³ç´°å…§å®¹ - æ”¶åˆå€åŸŸ */}
                                        {isOpen && (
                                            <div className="px-6 pb-6 bg-slate-50 animate-fadeIn">
                                                <div className="space-y-2 pt-2">
                                                    {session.items.map((item, idx) => (
                                                        <div key={idx} className="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center text-sm">
                                                            <div className="flex-1 pr-4">
                                                                <p className="text-slate-400 text-[10px] font-black mb-1 uppercase">Question {idx + 1}</p>
                                                                <p className="text-slate-700 font-medium truncate">{item.qText}</p>
                                                            </div>
                                                            <div className="flex items-center space-x-6">
                                                                <div className="text-right min-w-[60px]">
                                                                    <p className="text-slate-300 text-[10px] font-bold">è€—æ™‚</p>
                                                                    <p className="font-mono text-indigo-500 font-bold">{item.timeTaken}s</p>
                                                                </div>
                                                                <div className="text-center min-w-[40px]">
                                                                    <p className="text-slate-300 text-[10px] font-bold">çµæœ</p>
                                                                    <span className={`text-xl font-black ${item.isCorrect ? 'text-green-500' : 'text-red-500'}`}>
                                                                        {item.isCorrect ? 'âœ“' : 'âœ—'}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            // --- 4. ç®¡ç†å“¡ç™»å…¥ç•«é¢ ---
            if (view === 'admin_login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-xl w-full max-w-sm">
                            <h2 className="text-center font-black text-slate-800 text-xl mb-6 tracking-tighter">ADMIN ACCESS</h2>
                            <input type="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" 
                                className="w-full p-4 bg-slate-50 rounded-2xl mb-4 border-2 border-transparent focus:border-indigo-500 outline-none text-center font-bold tracking-widest"
                                onKeyDown={e => e.key === 'Enter' && e.target.value === '1208' && setView('admin')} autoFocus />
                            <p className="text-center text-[10px] text-slate-300 font-bold">é è¨­å¯†ç¢¼: 1208</p>
                            <button onClick={() => setView('login')} className="w-full mt-6 text-slate-400 font-bold text-sm hover:text-indigo-500">è¿”å›å­¸ç”Ÿç™»å…¥</button>
                        </div>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
