<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡é›²ç«¯æ¸¬é©— - å­¸ç¿’åˆ†æç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Lexend', 'Noto Sans TC', sans-serif; background-color: #F8FAFC; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAUlvu46XOZe5tKULG17nJLHaTA9-Cbp1c",
            authDomain: "eng-practice-d3a17.firebaseapp.com",
            databaseURL: "https://eng-practice-d3a17-default-rtdb.firebaseio.com", 
            projectId: "eng-practice-d3a17",
            storageBucket: "eng-practice-d3a17.firebasestorage.app",
            messagingSenderId: "1015937569709",
            appId: "1:1015937569709:web:b82f057d2068e1be4a4724",
            measurementId: "G-WNCJQDVXYY"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const studentConfig = {
            "éŸ‹ç³": { units: ["2/8 å–®å­—æ¸¬é©—"], pass: "1224" },
            "é›¨å½¤": { units: ["2/11 é€²éšæ¸¬é©—"], pass: "8888" }
        };

        // é¡Œç›®èˆ‡è§£æ... (ç¶­æŒåŸæ¨£)
        const weiLinData = [
            { id: 1, question: "The pyramids are an _______ structure from ancient Egypt.", options: ["ancient", "previous", "precise", "present"], correct: "ancient", explanation: "Ancient æŒ‡ã€Œå¤ä»£çš„ã€ã€‚", type: "vocabulary" },
            { id: 2, question: "My _______ came from mainland China many years ago.", options: ["antonyms", "ancestors", "antibiotics", "antidotes"], correct: "ancestors", explanation: "Ancestor æ˜¯ã€Œç¥–å…ˆã€ã€‚", type: "vocabulary" },
            { id: 3, question: "This _______ vase is worth a lot of money.", options: ["antique", "anticipate", "antibody", "ancient"], correct: "antique", explanation: "Antique æ˜¯ã€Œå¤è‘£ã€ã€‚", type: "vocabulary" },
            { id: 4, question: "The doctor gave him an _______ to counteract the poison.", options: ["antidote", "antonym", "antibiotic", "antibody"], correct: "antidote", explanation: "Antidote æ˜¯ã€Œè§£æ¯’åŠ‘ã€ã€‚", type: "vocabulary" },
            { id: 5, question: "I _______ that we will have a great time at the party.", options: ["anticipate", "precede", "preserve", "predict"], correct: "anticipate", explanation: "Anticipate æ˜¯ã€Œé æœŸã€æœŸå¾…ã€ã€‚", type: "vocabulary" },
            { id: 6, question: "The body produces _______ to fight off viruses.", options: ["antibodies", "antibiotics", "antonyms", "ancestors"], correct: "antibodies", explanation: "Antibody æ˜¯ã€ŒæŠ—é«”ã€ã€‚", type: "vocabulary" },
            { id: 7, question: "We must take every _______ to stay safe.", options: ["precaution", "preference", "presence", "previous"], correct: "precaution", explanation: "Precaution æ˜¯ã€Œé˜²ç¯„æªæ–½ã€ã€‚", type: "vocabulary" },
            { id: 8, question: "It's hard to _______ who will win the game.", options: ["predict", "prevent", "prepare", "preserve"], correct: "predict", explanation: "Predict æ˜¯ã€Œé çŸ¥ã€é æ¸¬ã€ã€‚", type: "vocabulary" },
            { id: 9, question: "He has a strong _______ for coffee over tea.", options: ["preference", "presence", "precaution", "previous"], correct: "preference", explanation: "Preference æ˜¯ã€Œåå¥½ã€ã€‚", type: "vocabulary" },
            { id: 10, question: "Your _______ is required at the meeting.", options: ["presence", "present", "precede", "preserve"], correct: "presence", explanation: "Presence æ˜¯ã€Œå‡ºå¸­ã€å­˜åœ¨ã€ã€‚", type: "vocabulary" }
        ];

        const yuTongData = [
            { id: 1, question: "The manager needs to _______ the upcoming project's potential risks.", options: ["anticipate", "ancient", "antidote", "ancestor"], correct: "anticipate", explanation: "Anticipate æŒ‡ã€Œé æœŸã€é æ–™ã€ã€‚", type: "vocabulary" }
        ];

        function App() {
            const [view, setView] = useState('login'); 
            const [studentName, setStudentName] = useState('');
            const [availableUnits, setAvailableUnits] = useState([]);
            const [selectedUnit, setSelectedUnit] = useState('');
            const [allLogs, setAllLogs] = useState([]);
            const [expandedId, setExpandedId] = useState(null);
            const [showWrongList, setShowWrongList] = useState(false);
            const [wrongTypeFilter, setWrongTypeFilter] = useState('vocabulary');
            const [status, setStatus] = useState('idle');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [sessionAnswers, setSessionAnswers] = useState([]);
            const [adminStudentFilter, setAdminStudentFilter] = useState('All');
            const [adminUnitFilter, setAdminUnitFilter] = useState('All');
            const startTimeRef = useRef(null);

            const quizData = studentName === "éŸ‹ç³" ? weiLinData : (studentName === "é›¨å½¤" ? yuTongData : []);

            useEffect(() => {
                if (studentName && studentConfig[studentName]) {
                    setAvailableUnits(studentConfig[studentName].units);
                    setSelectedUnit(studentConfig[studentName].units[0]);
                }
            }, [studentName]);

            useEffect(() => {
                const logsRef = db.ref('quiz_sessions');
                logsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setAllLogs(Object.entries(data).map(([id, val]) => ({ id, ...val })).reverse());
                    } else setAllLogs([]);
                });
                return () => logsRef.off();
            }, []);

            // æ•¸æ“šè¨ˆç®—
            const studentLogs = useMemo(() => allLogs.filter(log => log.name === studentName), [allLogs, studentName]);
            const stats = useMemo(() => {
                if (studentLogs.length === 0) return { avgScore: 0, total: 0, wrongQuestions: [] };
                const totalScore = studentLogs.reduce((acc, curr) => acc + curr.score, 0);
                const wrongs = [];
                studentLogs.forEach(log => {
                    log.details.forEach(d => {
                        if (!d.isCorrect) {
                            wrongs.push({ ...d, timestamp: log.timestamp, unit: log.unit });
                        }
                    });
                });
                return {
                    avgScore: Math.round(totalScore / studentLogs.length),
                    total: studentLogs.length,
                    wrongQuestions: wrongs
                };
            }, [studentLogs]);

            const handleLoginAttempt = (inputPass, targetView) => {
                if (targetView === 'admin') {
                    if (inputPass === '1208') setView('admin');
                    else alert('å¯†ç¢¼éŒ¯èª¤');
                } else {
                    if (inputPass === studentConfig[studentName].pass) setView('dashboard');
                    else alert('å¯†ç¢¼éŒ¯èª¤');
                }
            };

            const finishQuiz = () => {
                const correctCount = sessionAnswers.filter(a => a.isCorrect).length;
                const score = Math.round((correctCount / quizData.length) * 100);
                const totalTime = sessionAnswers.reduce((sum, a) => sum + parseFloat(a.timeTaken), 0).toFixed(1);
                
                const finalData = { 
                    name: studentName, unit: selectedUnit, timestamp: new Date().toLocaleString(), 
                    score, totalTime, details: sessionAnswers 
                };

                db.ref('quiz_sessions').push(finalData).then(() => {
                    setView('dashboard');
                    setSessionAnswers([]);
                    setCurrentIdx(0);
                    setStatus('idle');
                });
            };

            const RecordCard = ({ session, isAdminView }) => {
                const isOpen = expandedId === session.id;
                const color = session.score >= 80 ? 'text-green-500' : (session.score >= 60 ? 'text-blue-500' : 'text-red-500');
                return (
                    <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden mb-3">
                        <div className="p-5 flex justify-between items-center cursor-pointer" onClick={() => setExpandedId(isOpen ? null : session.id)}>
                            <div className="flex items-center space-x-3">
                                <div className="text-xl font-black">{session.score >= 60 ? 'âœ…' : 'âŒ'}</div>
                                <div>
                                    <h4 className="font-black text-slate-700 text-sm">{session.unit}</h4>
                                    <p className="text-[10px] text-slate-300 font-bold uppercase">{session.timestamp}</p>
                                </div>
                            </div>
                            <div className="flex items-center space-x-4">
                                <div className="text-right"><p className="text-[8px] text-slate-400 font-black uppercase">Score</p><p className={`font-black text-lg ${color}`}>{session.score}</p></div>
                                {isAdminView && (
                                    <button onClick={(e) => {e.stopPropagation(); if(confirm('åˆªé™¤ï¼Ÿ')) db.ref(`quiz_sessions/${session.id}`).remove();}} className="text-red-200 hover:text-red-500">ğŸ—‘ï¸</button>
                                )}
                                <div className={`text-slate-300 transition-transform ${isOpen ? 'rotate-180' : ''}`}>â–¼</div>
                            </div>
                        </div>
                        {isOpen && (
                            <div className="px-5 pb-5 animate-fadeIn space-y-2">
                                {session.details.map((d, i) => (
                                    <div key={i} className="text-[11px] p-3 bg-slate-50 rounded-xl flex justify-between">
                                        <span className="font-bold text-slate-500 flex-1 truncate">{d.qText}</span>
                                        <span className={d.isCorrect ? "text-green-500" : "text-red-500"}>{d.isCorrect ? "âœ“" : `âœ— (${d.choice})`}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            if (view === 'login') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-indigo-600 p-6">
                        <div className="bg-white p-10 rounded-[3.5rem] shadow-2xl w-full max-w-sm text-center">
                            <h1 className="text-4xl font-black text-indigo-900 mb-2 italic">EngQuiz</h1>
                            <div className="space-y-4 my-8">
                                <select className="w-full p-5 bg-slate-50 rounded-2xl font-black text-indigo-900"
                                    value={studentName} onChange={e => setStudentName(e.target.value)}>
                                    <option value="">é¸æ“‡å­¸ç”Ÿ</option>
                                    {Object.keys(studentConfig).map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                                <select className="w-full p-5 bg-slate-50 rounded-2xl font-black text-indigo-900"
                                    value={selectedUnit} onChange={e => setSelectedUnit(e.target.value)} disabled={!studentName}>
                                    {availableUnits.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                            </div>
                            <div className="flex space-x-3">
                                <button onClick={() => studentName && setView('quiz')} className="flex-1 bg-indigo-500 text-white py-5 rounded-2xl font-black shadow-lg">é–‹å§‹æ¸¬é©—</button>
                                <button onClick={() => setView('dashboard_login')} className="flex-1 bg-slate-100 text-slate-500 py-5 rounded-2xl font-black">æ­·å²ç´€éŒ„</button>
                            </div>
                            <button onClick={() => setView('admin_login')} className="mt-8 text-indigo-200 text-xs font-black uppercase">Teacher Login</button>
                        </div>
                    </div>
                );
            }

            if (view === 'dashboard_login' || view === 'admin_login') {
                const isAdmin = view === 'admin_login';
                return (
                    <div className="min-h-screen flex items-center justify-center p-6">
                        <div className="bg-white p-10 rounded-[3rem] shadow-xl w-full max-w-sm text-center">
                            <h2 className="font-black text-slate-800 mb-6">{isAdmin ? 'è€å¸«ç™»å…¥' : `${studentName} çš„å„€è¡¨æ¿`}</h2>
                            <input type="password" placeholder="Passcode" className="w-full p-5 bg-slate-50 rounded-2xl mb-4 text-center font-black tracking-[1em]"
                                onKeyDown={e => e.key === 'Enter' && handleLoginAttempt(e.target.value, isAdmin ? 'admin' : 'dashboard')} autoFocus />
                            <button onClick={() => setView('login')} className="text-slate-300 text-xs font-black">è¿”å›</button>
                        </div>
                    </div>
                );
            }

            if (view === 'quiz') {
                if (status === 'idle') startTimeRef.current = Date.now();
                const currentQ = quizData[currentIdx];
                return (
                    <div className="max-w-md mx-auto mt-12 p-8 bg-white rounded-[3.5rem] shadow-xl">
                        <div className="flex justify-between items-center mb-10"><span className="text-[10px] font-black px-3 py-1 bg-indigo-50 text-indigo-500 rounded-lg">{selectedUnit}</span><span className="text-xs font-black text-slate-300">{currentIdx + 1}/{quizData.length}</span></div>
                        <h2 className="text-2xl font-black text-slate-800 mb-10 leading-tight">{currentQ.question}</h2>
                        <div className="space-y-3">{currentQ.options.map((opt, i) => (
                            <button key={i} onClick={() => status === 'idle' && (() => {
                                const time = ((Date.now() - startTimeRef.current) / 1000).toFixed(2);
                                setSessionAnswers([...sessionAnswers, { qText: currentQ.question, choice: opt, isCorrect: opt === currentQ.correct, timeTaken: time, type: currentQ.type || 'vocabulary' }]);
                                setSelectedOption(opt); setStatus('answered');
                            })()} className={`w-full p-5 text-left border-2 rounded-2xl font-black transition-all ${status === 'answered' ? (opt === currentQ.correct ? 'border-green-500 bg-green-50 text-green-600' : (opt === selectedOption ? 'border-red-500 bg-red-50 text-red-600' : 'opacity-20 border-slate-50')) : 'border-slate-100 hover:border-indigo-500'}`}>{opt}</button>
                        ))}</div>
                        {status === 'answered' && <div className="mt-8 animate-fadeIn"><div className="bg-slate-50 p-5 rounded-2xl text-sm mb-6">è§£æï¼š{currentQ.explanation}</div><button onClick={() => { if(currentIdx < quizData.length - 1) { setCurrentIdx(currentIdx+1); setStatus('idle'); } else finishQuiz(); }} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black">ä¸‹ä¸€é¡Œ</button></div>}
                    </div>
                );
            }

            if (view === 'dashboard') {
                return (
                    <div className="max-w-4xl mx-auto p-6 animate-fadeIn pb-20">
                        {/* å­¸ç¿’æˆæ•ˆå€ */}
                        <div className="bg-indigo-600 rounded-[3rem] p-8 text-white mb-8 shadow-2xl relative overflow-hidden">
                            <div className="flex flex-col md:flex-row items-center justify-between gap-8 relative z-10">
                                <div>
                                    <h1 className="text-3xl font-black tracking-tighter mb-2 italic">Learning Analytics</h1>
                                    <p className="opacity-70 font-bold text-sm">Hello, {studentName}! é€™æ˜¯æ‚¨çš„å­¸ç¿’æˆ°å ±ã€‚</p>
                                    <div className="flex gap-4 mt-6">
                                        <div className="bg-white/10 p-4 rounded-3xl backdrop-blur-md">
                                            <p className="text-[10px] font-black uppercase opacity-60">æ¸¬é©—æ¬¡æ•¸</p>
                                            <p className="text-2xl font-black">{stats.total}</p>
                                        </div>
                                        <div className="bg-white/10 p-4 rounded-3xl backdrop-blur-md">
                                            <p className="text-[10px] font-black uppercase opacity-60">å¹³å‡åˆ†æ•¸</p>
                                            <p className="text-2xl font-black">{stats.avgScore}</p>
                                        </div>
                                    </div>
                                </div>
                                {/* åœ“ç’°é€²åº¦æ¢ */}
                                <div className="relative flex items-center justify-center">
                                    <svg className="w-32 h-32">
                                        <circle className="text-white/20" strokeWidth="8" stroke="currentColor" fill="transparent" r="50" cx="64" cy="64" />
                                        <circle className="text-white progress-ring__circle" strokeWidth="8" strokeDasharray="314.159" strokeDashoffset={314.159 - (stats.avgScore / 100) * 314.159} strokeLinecap="round" stroke="currentColor" fill="transparent" r="50" cx="64" cy="64" />
                                    </svg>
                                    <div className="absolute text-2xl font-black">{stats.avgScore}%</div>
                                </div>
                            </div>
                        </div>

                        {/* éŒ¯é¡Œå€ */}
                        <div className="mb-8">
                            <div className="flex justify-between items-end mb-4 px-2">
                                <h2 className="text-xl font-black text-slate-800">éŒ¯é¡Œè‹±é›„æ¦œ <span className="text-xs bg-red-100 text-red-500 px-2 py-1 rounded-full ml-1">{stats.wrongQuestions.length}</span></h2>
                                <button onClick={() => setShowWrongList(!showWrongList)} className="text-indigo-500 font-black text-xs uppercase tracking-widest">{showWrongList ? 'æ”¶åˆ' : 'å±•é–‹åˆ†æ'}</button>
                            </div>
                            
                            {showWrongList && (
                                <div className="bg-white border-4 border-indigo-50 rounded-[2.5rem] p-6 mb-6 animate-fadeIn">
                                    <div className="flex space-x-2 mb-6 bg-slate-50 p-1 rounded-2xl w-fit">
                                        <button onClick={() => setWrongTypeFilter('vocabulary')} className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${wrongTypeFilter === 'vocabulary' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}`}>å–®å­—å€</button>
                                        <button onClick={() => setWrongTypeFilter('grammar')} className={`px-6 py-2 rounded-xl text-xs font-black transition-all ${wrongTypeFilter === 'grammar' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}`}>æ–‡æ³•å€</button>
                                    </div>
                                    <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                        {stats.wrongQuestions.filter(q => q.type === wrongTypeFilter).length > 0 ? (
                                            stats.wrongQuestions.filter(q => q.type === wrongTypeFilter).map((q, i) => (
                                                <div key={i} className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex justify-between items-center group">
                                                    <div className="flex-1 mr-4">
                                                        <p className="text-[11px] font-black text-slate-600 leading-tight">{q.qText}</p>
                                                        <p className="text-[9px] text-slate-400 mt-1 font-bold italic">{q.unit} Â· Your answer: <span className="text-red-400">{q.choice}</span></p>
                                                    </div>
                                                    <div className="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-xs group-hover:scale-110 transition-transform">âŒ</div>
                                                </div>
                                            ))
                                        ) : (
                                            <div className="text-center py-10 text-slate-300 font-black italic">æ­¤å€æš«ç„¡éŒ¯é¡Œï¼Œå¤ªæ£’äº†ï¼</div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* æ­·å²æ¸…å–® */}
                        <div className="flex justify-between items-center mb-4 px-2">
                            <h2 className="text-xl font-black text-slate-800 italic uppercase">Records</h2>
                            <button onClick={() => setView('login')} className="bg-slate-900 text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase">Logout</button>
                        </div>
                        <div className="space-y-0">{studentLogs.map(log => <RecordCard key={log.id} session={log} isAdminView={false} />)}</div>
                    </div>
                );
            }

            // è€å¸«å¾Œå°ä»‹é¢ (ç¶­æŒç¯©é¸åŠŸèƒ½)
            if (view === 'admin') {
                const filteredLogs = allLogs.filter(log => (adminStudentFilter === 'All' || log.name === adminStudentFilter) && (adminUnitFilter === 'All' || log.unit === adminUnitFilter));
                return (
                    <div className="max-w-5xl mx-auto p-6 animate-fadeIn">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                            <h1 className="text-3xl font-black text-slate-900 italic tracking-tighter">DATA CENTER</h1>
                            <div className="flex gap-2">
                                <select className="bg-white border-2 border-indigo-100 text-indigo-600 px-4 py-2 rounded-xl text-xs font-black" value={adminStudentFilter} onChange={e => {setAdminStudentFilter(e.target.value); setAdminUnitFilter('All');}}>
                                    <option value="All">æ‰€æœ‰å­¸ç”Ÿ</option>
                                    {Object.keys(studentConfig).map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                                <select className="bg-white border-2 border-indigo-100 text-indigo-600 px-4 py-2 rounded-xl text-xs font-black" value={adminUnitFilter} onChange={e => setAdminUnitFilter(e.target.value)}>
                                    <option value="All">æ‰€æœ‰å–®å…ƒ</option>
                                    {[...new Set(allLogs.map(l => l.unit))].map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                                <button onClick={() => setView('login')} className="bg-slate-900 text-white px-5 py-2 rounded-xl font-black text-xs uppercase">Exit</button>
                            </div>
                        </div>
                        <div className="space-y-2">{filteredLogs.map(log => <RecordCard key={log.id} session={log} isAdminView={true} />)}</div>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
