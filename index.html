<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ÊñáÈõ≤Á´ØÂç≥ÊôÇÊ∏¨È©óÁ≥ªÁµ± - ËÄÅÂ∏´ÁÆ°ÁêÜÁâà</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Lexend', 'Noto Sans TC', sans-serif; background-color: #F8FAFC; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- üîë ‰Ω†ÁöÑÂ∞àÂ±¨ Firebase ÈÖçÁΩÆ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUlvu46XOZe5tKULG17nJLHaTA9-Cbp1c",
            authDomain: "eng-practice-d3a17.firebaseapp.com",
            databaseURL: "https://eng-practice-d3a17-default-rtdb.firebaseio.com", 
            projectId: "eng-practice-d3a17",
            storageBucket: "eng-practice-d3a17.firebasestorage.app",
            messagingSenderId: "1015937569709",
            appId: "1:1015937569709:web:b82f057d2068e1be4a4724",
            measurementId: "G-WNCJQDVXYY"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- È°åÂ∫´ÂçÄÂüü ---
        const quizData = [
            { id: 1, question: "She _______ to the library every Sunday morning.", options: ["go", "goes", "going", "gone"], correct: "goes", explanation: "‰∏ªË©ûÁÇ∫Á¨¨‰∏â‰∫∫Á®±ÂñÆÊï∏ (She)ÔºåÁèæÂú®ÂºèÂãïË©ûÈúÄÂä† s/es„ÄÇ" },
            { id: 2, question: "I am looking forward to _______ you soon.", options: ["see", "saw", "seeing", "seen"], correct: "seeing", explanation: "look forward to ÈÄôË£°ÁöÑ to ÊòØ‰ªãÁ≥ªË©ûÔºåÂæåÊñπÂøÖÈ†àÊé•ÂãïÂêçË©û V-ing„ÄÇ" },
            { id: 3, question: "The movie was so _______ that I fell asleep.", options: ["excited", "exciting", "bored", "boring"], correct: "boring", explanation: "ÂΩ¢ÂÆπ‰∫ãÁâ©ÔºàÈõªÂΩ±ÔºâËÆì‰∫∫ÊÑüÂà∞ÁÑ°ËÅäÔºåÊáâ‰ΩøÁî® V-ing ÂΩ¢ÂºèÁöÑÂΩ¢ÂÆπË©û„ÄÇ" }
        ];

        function App() {
            const [view, setView] = useState('login'); 
            const [studentName, setStudentName] = useState('');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [status, setStatus] = useState('idle');
            const [selectedOption, setSelectedOption] = useState(null);
            const [allLogs, setAllLogs] = useState([]);
            const [expandedSession, setExpandedSession] = useState(null);
            const startTimeRef = useRef(null);

            useEffect(() => {
                const logsRef = db.ref('quiz_logs');
                logsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) setAllLogs(Object.values(data));
                });
                return () => logsRef.off();
            }, []);

            const handleAnswer = (choice) => {
                const endTime = Date.now();
                const timeTaken = ((endTime - startTimeRef.current) / 1000).toFixed(2);
                const isCorrect = choice === quizData[currentIdx].correct;
                
                const now = new Date();
                const sessionID = `${studentName}_${now.toLocaleDateString()}_${now.getHours()}:${now.getMinutes()}`;

                const logData = {
                    name: studentName,
                    sessionID: sessionID,
                    qId: quizData[currentIdx].id,
                    qText: quizData[currentIdx].question,
                    choice,
                    isCorrect,
                    timeTaken,
                    timestamp: now.toLocaleString()
                };

                db.ref('quiz_logs').push(logData);
                setSelectedOption(choice);
                setStatus(isCorrect ? 'correct' : 'wrong');
            };

            // --- 1. Â≠∏ÁîüÁôªÂÖ• ---
            if (view === 'login') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-indigo-600 p-6">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
                            <h1 className="text-3xl font-black text-indigo-900 mb-2">EngQuiz</h1>
                            <p className="text-slate-400 text-sm mb-8 font-bold">Èõ≤Á´ØÂêåÊ≠•Ê∏¨È©óÁ≥ªÁµ±</p>
                            <input type="text" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç" 
                                className="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl mb-4 text-center font-bold outline-none"
                                value={studentName} onChange={e => setStudentName(e.target.value)} />
                            <button onClick={() => studentName && setView('quiz')} 
                                className="w-full bg-indigo-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-all">
                                ÈñãÂßãÊ∏¨È©ó
                            </button>
                            <button onClick={() => setView('admin_login')} className="mt-8 text-indigo-200 text-xs font-bold hover:text-white transition-colors">ÁÆ°ÁêÜÂì°ÁôªÂÖ•</button>
                        </div>
                    </div>
                );
            }

            // --- 2. Â≠∏ÁîüÊ∏¨È©ó ---
            if (view === 'quiz') {
                if (status === 'idle') startTimeRef.current = Date.now();
                return (
                    <div className="max-w-md mx-auto mt-12 p-8 bg-white rounded-[2.5rem] shadow-xl border border-slate-100">
                        <div className="flex justify-between items-center mb-6">
                            <span className="text-[10px] font-black text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full uppercase tracking-widest">Live</span>
                            <span className="text-xs font-bold text-slate-300">Q {currentIdx + 1} / {quizData.length}</span>
                        </div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-8 leading-tight">{quizData[currentIdx].question}</h2>
                        <div className="space-y-3">
                            {quizData[currentIdx].options.map((opt, i) => {
                                let btnClass = "border-slate-50 hover:border-indigo-500 hover:bg-indigo-50";
                                if (status !== 'idle') {
                                    if (opt === quizData[currentIdx].correct) btnClass = "border-green-500 bg-green-50 text-green-700 shadow-sm";
                                    else if (opt === selectedOption && status === 'wrong') btnClass = "border-red-500 bg-red-50 text-red-700 animate-shake";
                                    else btnClass = "border-slate-50 opacity-30";
                                }
                                return (
                                    <button key={i} onClick={() => status === 'idle' && handleAnswer(opt)}
                                        className={`w-full p-5 text-left border-2 rounded-2xl font-bold transition-all ${btnClass}`}>
                                        {opt}
                                    </button>
                                );
                            })}
                        </div>
                        {status !== 'idle' && (
                            <div className={`mt-8 p-6 rounded-3xl border-2 transition-all ${status === 'correct' ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                                <h3 className={`font-black mb-2 ${status === 'correct' ? 'text-green-600' : 'text-red-600'}`}>
                                    {status === 'correct' ? '‚úÖ Á≠îÂ∞ç‰∫ÜÔºÅ' : `‚ùå Á≠îÈåØ‰∫Ü (Ê≠£Ëß£: ${quizData[currentIdx].correct})`}
                                </h3>
                                <p className="text-sm text-slate-600 mb-4 bg-white/50 p-3 rounded-xl border border-white">
                                    <strong>Ëß£ÊûêÔºö</strong>{quizData[currentIdx].explanation}
                                </p>
                                <button onClick={() => {
                                    if(currentIdx < quizData.length - 1) { setCurrentIdx(currentIdx+1); setStatus('idle'); setSelectedOption(null); }
                                    else { alert("Ê∏¨È©óÂÆåÊàêÔºÅ"); setView('login'); setCurrentIdx(0); setStatus('idle'); }
                                }} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">
                                    {currentIdx < quizData.length - 1 ? "‰∏ã‰∏ÄÈ°å" : "ÂõûÈ¶ñÈ†Å"}
                                </button>
                            </div>
                        )}
                    </div>
                );
            }

            // --- 3. ËÄÅÂ∏´ÁÆ°ÁêÜÂæåÂè∞ ---
            if (view === 'admin') {
                const sessions = allLogs.reduce((acc, log) => {
                    const key = log.sessionID || `${log.name}_unknown`;
                    if (!acc[key]) acc[key] = { name: log.name, time: log.timestamp, items: [] };
                    acc[key].items.push(log);
                    return acc;
                }, {});

                const sortedSessions = Object.entries(sessions).reverse();

                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-black text-slate-800 tracking-tighter">DATA CENTER</h1>
                            <button onClick={() => setView('login')} className="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold shadow-lg">ÈÄÄÂá∫</button>
                        </div>
                        <div className="space-y-4">
                            {sortedSessions.map(([sessionKey, data]) => {
                                const correctCount = data.items.filter(i => i.isCorrect).length;
                                const totalTime = data.items.reduce((sum, i) => sum + parseFloat(i.timeTaken), 0).toFixed(1);
                                const isExpanded = expandedSession === sessionKey;
                                return (
                                    <div key={sessionKey} className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                                        <div className="p-6 cursor-pointer hover:bg-slate-50 flex justify-between items-center" onClick={() => setExpandedSession(isExpanded ? null : sessionKey)}>
                                            <div className="flex items-center space-x-4">
                                                <div className="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center font-black">{data.name.charAt(0)}</div>
                                                <div>
                                                    <h3 className="font-black text-slate-700">{data.name}</h3>
                                                    <p className="text-[10px] text-slate-300 font-bold uppercase">{data.time}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-8">
                                                <div className="text-center">
                                                    <p className="text-[9px] text-slate-400 font-black uppercase">Ê≠£Á¢∫Áéá</p>
                                                    <p className={`font-black ${correctCount === data.items.length ? 'text-green-500' : 'text-orange-500'}`}>{correctCount}/{data.items.length}</p>
                                                </div>
                                                <div className="text-center">
                                                    <p className="text-[9px] text-slate-400 font-black uppercase">Á∏ΩÊôÇÈï∑</p>
                                                    <p className="font-black text-slate-700">{totalTime}s</p>
                                                </div>
                                                <div className={`text-slate-300 transition-transform ${isExpanded ? 'rotate-180' : ''}`}>‚ñº</div>
                                            </div>
                                        </div>
                                        {isExpanded && (
                                            <div className="px-6 pb-6 bg-slate-50/50 animate-fadeIn">
                                                <div className="space-y-2 mt-4">
                                                    {data.items.map((item, i) => (
                                                        <div key={i} className="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 text-xs">
                                                            <span className="font-bold text-slate-500 flex-1">Q{item.qId}. {item.qText.substring(0, 30)}...</span>
                                                            <div className="flex items-center space-x-4">
                                                                <span className="text-slate-300">{item.timeTaken}s</span>
                                                                <span className={item.isCorrect ? "text-green-500 font-black" : "text-red-500 font-black"}>
                                                                    {item.isCorrect ? "‚úì" : `‚úó (${item.choice})`}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            // --- 4. ÁÆ°ÁêÜÂì°ÁôªÂÖ• ---
            if (view === 'admin_login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-xl w-full max-w-sm">
                            <h2 className="text-center font-black text-slate-800 text-xl mb-6 tracking-tighter">ADMIN ACCESS</h2>
                            <input type="password" placeholder="Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂØÜÁ¢º" 
                                className="w-full p-4 bg-slate-50 rounded-2xl mb-4 border-2 border-transparent focus:border-indigo-500 outline-none text-center font-bold tracking-widest"
                                onKeyDown={e => e.key === 'Enter' && e.target.value === '1208' && setView('admin')} autoFocus />
                            <button onClick={() => setView('login')} className="w-full mt-6 text-slate-400 font-bold text-sm text-center">ËøîÂõûÊ∏¨È©ó</button>
                        </div>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
